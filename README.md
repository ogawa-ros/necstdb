# NECSTDB

[![PyPI](https://img.shields.io/pypi/v/necstdb.svg?label=PyPI&style=flat-square)](https://pypi.org/pypi/necstdb/)
[![Python](https://img.shields.io/pypi/pyversions/necstdb.svg?label=Python&color=yellow&style=flat-square)](https://pypi.org/pypi/necstdb/)
[![Test](https://img.shields.io/github/workflow/status/nanten2/necstdb/Test?logo=github&label=Test&style=flat-square)](https://github.com/ogawa-ros/necstdb/actions)
[![License](https://img.shields.io/badge/license-MIT-blue.svg?label=License&style=flat-square)](LICENSE)

Database for NECST.

## TL;DR

NECST, an abbreviation of *NEw Control System for Telescope*, is a flexible controlling system for radio telescopes. Its efficient data storage format is provided here.

The database contains tables, which keep individual topic of time series data with some metadata attached to them, e.g. spectral data from one spectrometer board (array of data + timestamp), weather data (temperature + humidity + wind speed + ... + timestamp), etc.

## Features

This package provides:

- database writer with quite flexible metadata support
- database reader which output supports various python formats

## Installation

```shell
pip install necstdb
```

## Usage

### Database Writer

1. Create new database instance

    ```python
    >>> db_dir = "path/to/new_database_directory"
    >>> db = necstdb.opendb(db_dir, mode="w")  # "w" stands for "write mode"
    ```

2. Prepare and format the data

    ```python
    >>> data1 = [1.6294488758e9, 3, b"SKY", 1.6294488757e9]  # string data are not allowed, use bytes instead
    >>> data1_info = {
    ...     "data": [
    ...         {"key": "recorded_time", "format": "d", "size": 8},
    ...         {"key": "n_scan_lines", "format": "i", "size": 4},
    ...         {"key": "obsmode", "format": "3s", "size": 3},
    ...         {"key": "timestamp", "format": "d", "size": 8},
    ...     ],
    ...     "memo": "generated by db_logger_operation",
    ...     "necstdb_version": necstdb.__version__,
    ... }
    ```

    The keys "key", "format" and "size" in "data" list are required. For the format character and the size, see the [documentation](https://docs.python.org/3/library/struct.html#format-characters).

    The "memo" and "necstdb_version" keys are not necessary. You can also add any other keys to the data information dict.

3. Create and write individual table of data

    ```python
    >>> db.create_table("data1", data1_info)
    >>> table1 = db.open_table("data1", mode="ab")  # "ab" stands for "append binary mode"
    >>> table1.append(*data1)
    ```

### Database Reader

1. Open the database instance

    ```python
    >>> db = necstdb.opendb("path/to/database_directory")
    ```

2. Read a desired topic

    ```python
    >>> data1 = db.open_table("data1").read(astype="array")
    >>> data1
    array([[1.6294488758e9, 3, b'SKY', 1.6294488757e9], ...], dtype=[('recorded_time', '<f8'), ('n_scan_lines', '<i4'), ('obsmode', '|S3'), ('timestamp', '<f8')])
    ```

### Misc

#### List all the tables contained in the database

```python
>>> db = necstdb.opendb("path/to/database_directory")
>>> db.list_tables()
['data1', 'spectral_data', 'weather_data', ...]
```

#### Archive the database

```python
>>> db = necstdb.opendb("path/to/database_directory")
>>> db.checkout(saveto="path/to/archive.tar.gz", compression="gz")
```

#### Get informations of all tables in the database

```python
>>> db = necstdb.opendb("path/to/database_directory")
>>> db.get_info()
"""
                    file size [byte]    #records    record size [byte]  format
table name
data1               2448                102         24                  di3sd
spectral_data       41948160            320         131088              d32768fd
weather_data        6328                113         56                  ddddddd
"""
```

#### Read particular columns and/or rows of the database

```python
>>> db = necstdb.opendb("path/to/database_directory")
>>> data = db.open_table("data1").read(num=5, start=3, cols=["timestamp", "obsmode"], astype="tuple")  # order of cols won't be preserved
((b'SKY', 1.6294488788e9)  # 3rd element (caution 0-based indexing)
 (b'SKY', 1.6294488798e9)
 (b'SKY', 1.6294488808e9)
 (b'SKY', 1.6294488818e9)
 (b'HOT', 1.6294488828e9))
```
